- name: checking yum repo
  stat:
    path: /etc/yum.repos.d/pgdg-redhat-all.repo
  register: stat_yum_repo
- name: Provisioning PostgreSQL
  include_tasks: provision_db.yml
- copy:
    dest: /etc/dcache/ban.conf
    owner: dcache
    group: dcache
    content: ""
    mode: "0644" 
- name: Ensure grid-security directory exists
  file:
    path: /etc/grid-security
    state: directory
    owner: root
    group: root
    mode: "0755"
- template:
    src: dcache.conf.j2
    dest: /etc/dcache/dcache.conf
    owner: dcache
    group: dcache
    mode: "0644"
- name: Render gplazma.conf when door/frontend
  ansible.builtin.template:
    src: gplazma.conf.j2
    dest: /etc/dcache/gplazma.conf
    owner: dcache
    group: dcache
    mode: "0644"
  when: dcache_layout_type in ["frontend","standalone"]
- name: Ensure htpasswd users when enabled
  community.general.htpasswd:
    path: /etc/dcache/htpasswd
    name: "{{ item.name }}"
    password: "{{ item.password }}"
    owner: dcache
    group: dcache
    mode: 0640
  loop:
    - { name: "vagrant", password: "vagrant" }
    - { name: "admin", password: "admin" }
  when:
    - dcache_layout_type in ["frontend","standalone"]
    - dcache_use_htpasswd | default(true)
- name: Require unified accounts on doors
  assert:
    that:
      - (dcache_accounts | default([])) | length > 0
    fail_msg: "dcache_accounts must be provided to generate storage-authzdb and grid-vorolemap."
  when: dcache_layout_type in ["frontend","standalone"]
- name: Ensure each account has at least one storage entry
  assert:
    that:
      - item.entries is defined
      - item.entries | length > 0
    fail_msg: "Account '{{ item.username | default('UNKNOWN') }}' must define entries (root/path)."
  loop: "{{ dcache_accounts | default([]) }}"
  loop_control:
    label: "{{ item.username }}"
  when: dcache_layout_type in ["frontend","standalone"]
- name: Ensure each account has at least one VOMS FQAN when VOMS enabled
  assert:
    that:
      - item.voms_fqans is defined
      - item.voms_fqans | length > 0
    fail_msg: "Account '{{ item.username | default('UNKNOWN') }}' must define voms_fqans when dcache_use_voms=true."
  loop: "{{ dcache_accounts | default([]) }}"
  loop_control:
    label: "{{ item.username }}"
  when:
    - dcache_layout_type in ["frontend","standalone"]
    - dcache_use_voms | default(true)
- name: Render storage-authzdb
  ansible.builtin.template:
    src: storage-authzdb.j2
    dest: /etc/grid-security/storage-authzdb
    owner: dcache
    group: dcache
    mode: "0644"
  when: dcache_layout_type in ["frontend","standalone"]
- name: Render grid-vorolemap
  ansible.builtin.template:
    src: grid-vorolemap.j2
    dest: /etc/grid-security/grid-vorolemap
    owner: dcache
    group: dcache
    mode: "0644"
  when:
    - dcache_layout_type in ["frontend","standalone"]
    - dcache_use_voms | default(true)
- name: Render multimap file
  ansible.builtin.template:
    src: multi-mapfile.j2
    dest: /etc/dcache/multi-mapfile
    owner: dcache
    group: dcache
    mode: "0600"
  when: 
    - dcache_use_oidc
    - multimaps | default([]) | length > 0
- template: 
    src: layout.conf.j2
    dest: /etc/dcache/layouts/{{ dcache_layout }}.conf
    owner: dcache
    group: dcache
    mode: "0644"
- name: Restart dcache
  command: dcache restart
 
# Optional packages typically for door/frontend
- name: Install XRootD server
  package:
    name: xrootd-server
    state: latest
  when: dcache_layout_type in ["frontend","standalone"]
